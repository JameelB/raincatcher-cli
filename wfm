#!/bin/bash

WFM_CLI_DIR=$(dirname $(readlink -f $0))
WFM_DIR="$WFM_CLI_DIR/.."

APPS="wfm-cloud wfm-auth wfm-mobile wfm-portal"

APPS_DIR="$WFM_DIR"
MODULES_DIR="$WFM_DIR/modules"

# symlink all wfm modules:
#

pullApps () {
  for D in $APPS; do
    cd "$APPS_DIR/$D"
    echo #########
    echo `pwd`
    git pull
  done
}

pullModules () {
  ls "$MODULES_DIR/"
  for D in $MODULES_DIR/*; do
    cd $D
    echo #########
    echo `pwd`
    git pull
  done
}

linkApps () {
  for D in $APPS; do
    cd "$APPS_DIR/$D"
    echo #########
    echo 'linking: ' `pwd`
    linkToModules
  done
}

linkToModules () {
  MODULES=$(grep fh-wfm package.json | cut -d':' -f1 | tr -d ' "' | sed 's/fh-//')
  echo "Linking modules: $MODULES"
  for M in $MODULES; do
    npm link ../modules/$M
  done
}

cleanApps () {
  for D in $APPS; do
    cd "$APPS_DIR/$D"
    echo #########
    echo 'cleaning: ' `pwd`
    rm -rf node_modules
  done
}

case $1 in
  pull)
  pullApps
  pullModules
  ;;
  link)
  linkApps
  ;;
  clean)
  cleanApps
  ;;
  *)
  echo "Usage: wfm {pull|link}"
esac
